{"ast":null,"code":"import { __awaiter, __rest } from \"tslib\";\n/* eslint-disable @typescript-eslint/no-parameter-properties */\nimport { isFunction } from '../../utils';\nexport default class Fetch {\n  constructor(serviceRef, options, subscribe) {\n    let initState = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : {};\n    this.serviceRef = serviceRef;\n    this.options = options;\n    this.subscribe = subscribe;\n    this.initState = initState;\n    this.count = 0;\n    this.state = {\n      loading: false,\n      params: undefined,\n      data: undefined,\n      error: undefined\n    };\n    this.state = Object.assign(Object.assign(Object.assign({}, this.state), {\n      loading: !options.manual\n    }), initState);\n  }\n  setState() {\n    let s = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n    this.state = Object.assign(Object.assign({}, this.state), s);\n    this.subscribe();\n  }\n  runPluginHandler(event) {\n    for (var _len = arguments.length, rest = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {\n      rest[_key - 1] = arguments[_key];\n    }\n    // @ts-ignore\n    const r = this.pluginImpls.map(i => {\n      var _a;\n      return (_a = i[event]) === null || _a === void 0 ? void 0 : _a.call(i, ...rest);\n    }).filter(Boolean);\n    return Object.assign({}, ...r);\n  }\n  runAsync() {\n    for (var _len2 = arguments.length, params = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {\n      params[_key2] = arguments[_key2];\n    }\n    var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k;\n    return __awaiter(this, void 0, void 0, function* () {\n      this.count += 1;\n      const currentCount = this.count;\n      const _l = this.runPluginHandler('onBefore', params),\n        {\n          stopNow = false,\n          returnNow = false\n        } = _l,\n        state = __rest(_l, [\"stopNow\", \"returnNow\"]);\n      // stop request\n      if (stopNow) {\n        return new Promise(() => {});\n      }\n      this.setState(Object.assign({\n        loading: true,\n        params\n      }, state));\n      // return now\n      if (returnNow) {\n        return Promise.resolve(state.data);\n      }\n      (_b = (_a = this.options).onBefore) === null || _b === void 0 ? void 0 : _b.call(_a, params);\n      try {\n        // replace service\n        let {\n          servicePromise\n        } = this.runPluginHandler('onRequest', this.serviceRef.current, params);\n        if (!servicePromise) {\n          servicePromise = this.serviceRef.current(...params);\n        }\n        const res = yield servicePromise;\n        if (currentCount !== this.count) {\n          // prevent run.then when request is canceled\n          return new Promise(() => {});\n        }\n        // const formattedResult = this.options.formatResultRef.current ? this.options.formatResultRef.current(res) : res;\n        this.setState({\n          data: res,\n          error: undefined,\n          loading: false\n        });\n        (_d = (_c = this.options).onSuccess) === null || _d === void 0 ? void 0 : _d.call(_c, res, params);\n        this.runPluginHandler('onSuccess', res, params);\n        (_f = (_e = this.options).onFinally) === null || _f === void 0 ? void 0 : _f.call(_e, params, res, undefined);\n        if (currentCount === this.count) {\n          this.runPluginHandler('onFinally', params, res, undefined);\n        }\n        return res;\n      } catch (error) {\n        if (currentCount !== this.count) {\n          // prevent run.then when request is canceled\n          return new Promise(() => {});\n        }\n        this.setState({\n          error,\n          loading: false\n        });\n        (_h = (_g = this.options).onError) === null || _h === void 0 ? void 0 : _h.call(_g, error, params);\n        this.runPluginHandler('onError', error, params);\n        (_k = (_j = this.options).onFinally) === null || _k === void 0 ? void 0 : _k.call(_j, params, undefined, error);\n        if (currentCount === this.count) {\n          this.runPluginHandler('onFinally', params, undefined, error);\n        }\n        throw error;\n      }\n    });\n  }\n  run() {\n    this.runAsync(...arguments).catch(error => {\n      if (!this.options.onError) {\n        console.error(error);\n      }\n    });\n  }\n  cancel() {\n    this.count += 1;\n    this.setState({\n      loading: false\n    });\n    this.runPluginHandler('onCancel');\n  }\n  refresh() {\n    // @ts-ignore\n    this.run(...(this.state.params || []));\n  }\n  refreshAsync() {\n    // @ts-ignore\n    return this.runAsync(...(this.state.params || []));\n  }\n  mutate(data) {\n    const targetData = isFunction(data) ? data(this.state.data) : data;\n    this.runPluginHandler('onMutate', targetData);\n    this.setState({\n      data: targetData\n    });\n  }\n}","map":{"version":3,"names":["__awaiter","__rest","isFunction","Fetch","constructor","serviceRef","options","subscribe","initState","arguments","length","undefined","count","state","loading","params","data","error","Object","assign","manual","setState","s","runPluginHandler","event","_len","rest","Array","_key","r","pluginImpls","map","i","_a","call","filter","Boolean","runAsync","_len2","_key2","_b","_c","_d","_e","_f","_g","_h","_j","_k","currentCount","_l","stopNow","returnNow","Promise","resolve","onBefore","servicePromise","current","res","onSuccess","onFinally","onError","run","catch","console","cancel","refresh","refreshAsync","mutate","targetData"],"sources":["/Users/mac/Documents/store/my-app/node_modules/ahooks/es/useRequest/src/Fetch.js"],"sourcesContent":["import { __awaiter, __rest } from \"tslib\";\n/* eslint-disable @typescript-eslint/no-parameter-properties */\nimport { isFunction } from '../../utils';\nexport default class Fetch {\n  constructor(serviceRef, options, subscribe, initState = {}) {\n    this.serviceRef = serviceRef;\n    this.options = options;\n    this.subscribe = subscribe;\n    this.initState = initState;\n    this.count = 0;\n    this.state = {\n      loading: false,\n      params: undefined,\n      data: undefined,\n      error: undefined\n    };\n    this.state = Object.assign(Object.assign(Object.assign({}, this.state), {\n      loading: !options.manual\n    }), initState);\n  }\n  setState(s = {}) {\n    this.state = Object.assign(Object.assign({}, this.state), s);\n    this.subscribe();\n  }\n  runPluginHandler(event, ...rest) {\n    // @ts-ignore\n    const r = this.pluginImpls.map(i => {\n      var _a;\n      return (_a = i[event]) === null || _a === void 0 ? void 0 : _a.call(i, ...rest);\n    }).filter(Boolean);\n    return Object.assign({}, ...r);\n  }\n  runAsync(...params) {\n    var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k;\n    return __awaiter(this, void 0, void 0, function* () {\n      this.count += 1;\n      const currentCount = this.count;\n      const _l = this.runPluginHandler('onBefore', params),\n        {\n          stopNow = false,\n          returnNow = false\n        } = _l,\n        state = __rest(_l, [\"stopNow\", \"returnNow\"]);\n      // stop request\n      if (stopNow) {\n        return new Promise(() => {});\n      }\n      this.setState(Object.assign({\n        loading: true,\n        params\n      }, state));\n      // return now\n      if (returnNow) {\n        return Promise.resolve(state.data);\n      }\n      (_b = (_a = this.options).onBefore) === null || _b === void 0 ? void 0 : _b.call(_a, params);\n      try {\n        // replace service\n        let {\n          servicePromise\n        } = this.runPluginHandler('onRequest', this.serviceRef.current, params);\n        if (!servicePromise) {\n          servicePromise = this.serviceRef.current(...params);\n        }\n        const res = yield servicePromise;\n        if (currentCount !== this.count) {\n          // prevent run.then when request is canceled\n          return new Promise(() => {});\n        }\n        // const formattedResult = this.options.formatResultRef.current ? this.options.formatResultRef.current(res) : res;\n        this.setState({\n          data: res,\n          error: undefined,\n          loading: false\n        });\n        (_d = (_c = this.options).onSuccess) === null || _d === void 0 ? void 0 : _d.call(_c, res, params);\n        this.runPluginHandler('onSuccess', res, params);\n        (_f = (_e = this.options).onFinally) === null || _f === void 0 ? void 0 : _f.call(_e, params, res, undefined);\n        if (currentCount === this.count) {\n          this.runPluginHandler('onFinally', params, res, undefined);\n        }\n        return res;\n      } catch (error) {\n        if (currentCount !== this.count) {\n          // prevent run.then when request is canceled\n          return new Promise(() => {});\n        }\n        this.setState({\n          error,\n          loading: false\n        });\n        (_h = (_g = this.options).onError) === null || _h === void 0 ? void 0 : _h.call(_g, error, params);\n        this.runPluginHandler('onError', error, params);\n        (_k = (_j = this.options).onFinally) === null || _k === void 0 ? void 0 : _k.call(_j, params, undefined, error);\n        if (currentCount === this.count) {\n          this.runPluginHandler('onFinally', params, undefined, error);\n        }\n        throw error;\n      }\n    });\n  }\n  run(...params) {\n    this.runAsync(...params).catch(error => {\n      if (!this.options.onError) {\n        console.error(error);\n      }\n    });\n  }\n  cancel() {\n    this.count += 1;\n    this.setState({\n      loading: false\n    });\n    this.runPluginHandler('onCancel');\n  }\n  refresh() {\n    // @ts-ignore\n    this.run(...(this.state.params || []));\n  }\n  refreshAsync() {\n    // @ts-ignore\n    return this.runAsync(...(this.state.params || []));\n  }\n  mutate(data) {\n    const targetData = isFunction(data) ? data(this.state.data) : data;\n    this.runPluginHandler('onMutate', targetData);\n    this.setState({\n      data: targetData\n    });\n  }\n}"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}